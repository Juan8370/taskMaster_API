name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11, '3.x']
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requeriments.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requeriments.txt
      - name: Run tests
        run: python -m pytest -q

  test-postgres:
    name: Tests (PostgreSQL)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: taskmaster
          POSTGRES_PASSWORD: taskmaster
          POSTGRES_DB: taskmaster
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U taskmaster -d taskmaster" \
          --health-interval 5s \
          --health-timeout 5s \
          --health-retries 10
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requeriments.txt') }}-pg
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requeriments.txt
      - name: Wait for database to be ready
        env:
          DATABASE_URL: postgresql+psycopg://taskmaster:taskmaster@localhost:5432/taskmaster
        run: |
          python - <<'PY'
          import time, os
          import psycopg
          url = os.environ['DATABASE_URL']
          for i in range(30):
              try:
                  with psycopg.connect(url) as conn:
                      with conn.cursor() as cur:
                          cur.execute('SELECT 1')
                          print('DB ready')
                          raise SystemExit(0)
              except Exception as e:
                  print('Waiting for DB...', e)
                  time.sleep(2)
          raise SystemExit('DB not ready')
          PY
      - name: Run tests (PostgreSQL)
        env:
          DATABASE_URL: postgresql+psycopg://taskmaster:taskmaster@localhost:5432/taskmaster
        run: python -m pytest -q
